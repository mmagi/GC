<!DOCTYPE HTML>
<html manifest="" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>抖M魔物战斗模拟器</title>
    <script type="text/javascript" src="db.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

    <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//johnny.github.io/jquery-sortable/js/jquery-sortable-min.js"></script>
    <script src="multiselect.js?2"></script>
    <link rel="stylesheet" href="//davidstutz.github.io/bootstrap-multiselect/css/bootstrap-multiselect.css">
    <script type="text/javascript" src="canvasjs.min.js"></script>
    <script type="text/javascript" src="emulate.js?20141012b6"></script>
    <style>
        li.log{
            list-style-type: none;
        }
        li.branch{
            list-style-type: circle;
        }
        li.end{
            list-style-type: square;
        }
        .deck>li{
            display: block;
            list-style-type: none;
            padding: 2px 0;
            margin: 0;;
        }
        body.dragging, body.dragging * {
             cursor: move !important;
         }

        .dragged {
            position: absolute;
            opacity: 0.5;
            z-index: 2000;
        }
        .deck{
            min-width: 400px;;
            margin: 0;
            padding: 0;;
        }
        .deck>li.placeholder {
            position: relative;
            height: 38px;;
        }
        .deck>li.placeholder:before{
            position: absolute;
        }
    </style>
</head>
<body>
<h3 style="text-align: center">抖M魔物模拟器测试版v20141012b6</h3>
<ol id="leftdeck"  class="deck" style="float:left;"></ol>
<ol id="rightdeck"  class="deck" style="float:right;"></ol>
<div style="clear: both;width: 100%;text-align: center;">
    <div style="margin: 0 auto;">
        <button id="bt1" class="btn btn-primary" onclick="gofight(false)"><span class="glyphicon glyphicon-play"></span> 模拟</button>
        <button  id="bt2" class="btn" onclick="swapDeck()"><span class="glyphicon glyphicon-resize-horizontal"></span> 交换</button>
        <button  id="btc" class="btn" onclick="window.cancelRun = true"><span class="glyphicon glyphicon-stop"></span> 取消</button>
    </div>
</div>

<div id="chartContainer" style="height: 300px; width: 100%;">
</div>
<ul id="logContainer">
</ul>
<script type="text/javascript">

    //initial value of dataPoints
    var dps = [
        {label: "胜10", y: 0},
        {label: "胜9", y: 0},
        {label: "胜8", y: 0},
        {label: "胜7", y: 0},
        {label: "胜6", y: 0},
        {label: "胜5", y: 0},
        {label: "胜4", y: 0},
        {label: "胜3", y: 0},
        {label: "胜2", y: 0},
        {label: "胜1", y: 0},
        {label: "胜0", y: 0},
        {label: "负1", y: 0},
        {label: "负2", y: 0},
        {label: "负3", y: 0},
        {label: "负4", y: 0},
        {label: "负5", y: 0},
        {label: "负6", y: 0},
        {label: "负7", y: 0},
        {label: "负8", y: 0},
        {label: "负9", y: 0},
        {label: "负10", y: 0}
    ];

    var chart = new CanvasJS.Chart("chartContainer",{
        title: {
            text: "胜率分布"
        },
        axisY: {
            suffix: " %"
        },
        legend :{
            verticalAlign: 'bottom',
            horizontalAlign: "center"
        },
        data: [
            {
                type: "column",
                bevelEnabled: true,
                indexLabel: "{y}%",
                yValueFormatString:"0.0",
                dataPoints: dps
            }
        ]
    });


    chart.render();
    var cards=[{label:"无",value:0}];
    for (var idx in _db.cardStatus){
        if (idx<100000 && _db.cardStatus[idx][7]>0) cards.push({label:_db.cardStatus[idx][0],value:idx});
    }
    var types=[];
    for (var idx in _db.type){
        types.push({label:_db.type[idx][0],value:idx});
    }
    function caculate(lv1,lv60,rate,maxlv,re){
        var a = lv1+(lv60-lv1)*(maxlv-1+re*5)/(maxlv-1);
        return parseInt(rate*parseInt(a))+parseInt(0.2*a);

    }
    function card(p){
        var $body = $("<li>").appendTo(p)
        $body.append('<button type="button" class="btn btn-default btn-sort"><span class="glyphicon glyphicon-resize-vertical"></span></button>');
        var $card = $("<select>").appendTo($body);
        $card.multiselect({enableFiltering: true,maxHeight: 500,filterPlaceholder: '搜索'});
        $card.multiselect('dataprovider',cards);
        $card.multiselect('rebuild');
        $card.change(function(){
            var data=_db.cardStatus[$card.val()];
            var abi=[];
            if (!!data){
                if (data[20]) abi.push({label:_db.skill[data[21]][0],detail:_db.skill[data[21]][1],value:data[21]});
                if (data[22]) abi.push({label:_db.skill[data[23]][0],detail:_db.skill[data[23]][1],value:data[23]});
                if (data[24]) abi.push({label:_db.skill[data[25]][0],detail:_db.skill[data[25]][1],value:data[25]});
                if (data[26]) abi.push({label:_db.skill[data[27]][0],detail:_db.skill[data[27]][1],value:data[27]});
                if (data[28]) abi.push({label:_db.skill[data[29]][0],detail:_db.skill[data[29]][1],value:data[29]});
                if (data[30]) abi.push({label:_db.skill[data[31]][0],detail:_db.skill[data[31]][1],value:data[31]});
            }
            $abi.multiselect('dataprovider',abi);
        });
        var $type = $("<select>").appendTo($body);
        $type.multiselect('dataprovider',types);
        $type.val("7");
        var $abi = $("<select>",{multiple:"multiple"}).appendTo($body);
        $abi.multiselect({nonSelectedText:"未选择技能",nSelectedText:"个技能同时生效",disableIfEmpty: true});
        $body.data({getCard:function(){
            var data=_db.cardStatus[$card.val()];
            var tdata=_db.type[$type.val()];
            if (!data) return null;
            return {
                name:data[0],
                element:data[4],
                maxHp:caculate(data[ 8],data[14],tdata[1],data[5],data[7]),
                maxMp:caculate(data[ 9],data[15],tdata[2],data[5],data[7]),
                atk:  caculate(data[10],data[16],tdata[3],data[5],data[7]),
                def:  caculate(data[11],data[17],tdata[4],data[5],data[7]),
                spd:  caculate(data[12],data[18],tdata[5],data[5],data[7]),
                itl:  caculate(data[13],data[19],tdata[6],data[5],data[7]),
                abi:$abi.val()
            };
        }});
    }
    $("#btc").hide();
    var p = $("#leftdeck");
    for (var i = 0;i<10;i++){
        card(p);
    }
    p.sortable({handle:'button.btn-sort'});
    p = $("#rightdeck");
    for (var i = 0;i<10;i++){
        card(p);
    }
    p.sortable({handle:'button.btn-sort'});
    function gofight(swap){
        window.cancelRun = false;
        $("#bt1").attr("disabled", true);
        $("#bt2").attr("disabled", true);
        $("#btc").show();
        var l=[];
        var r=[];
        $("#leftdeck>li").each(function(idx,elemnt){
            var ret = $(elemnt).data().getCard();
            if (ret) l.push(ret);
        });
        $("#rightdeck>li").each(function(idx,elemnt){
            var ret = $(elemnt).data().getCard();
            if (ret) r.push(ret);
        });
        if(swap) analyse(r,l);
        else analyse(l,r);
    }
    function swapDeck(){
        var left = $("#leftdeck>li");
        var right = $("#rightdeck>li");
        $("#leftdeck").append(right);
        $("#rightdeck").append(left);
    }
</script>
</body>
</html>
